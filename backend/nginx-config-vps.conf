# Nginx Configuration for Drive Rwanda - Prep & Pass Backend
# Subdomain: drive-rwanda-prep (reflects system name)
# Deploy at: /etc/nginx/sites-available/drive-rwanda-prep.cyangugudims.com
# After deploy: sudo ln -s /etc/nginx/sites-available/drive-rwanda-prep.cyangugudims.com /etc/nginx/sites-enabled/

server {
    listen 80;
    listen [::]:80;
    server_name drive-rwanda-prep.cyangugudims.com www.drive-rwanda-prep.cyangugudims.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name drive-rwanda-prep.cyangugudims.com www.drive-rwanda-prep.cyangugudims.com;

    # SSL Certificate paths (Let's Encrypt) - run: certbot --nginx -d drive-rwanda-prep.cyangugudims.com
    ssl_certificate /etc/letsencrypt/live/drive-rwanda-prep.cyangugudims.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/drive-rwanda-prep.cyangugudims.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Root directory for static files
    root /var/www/learn-traffic-rules;

    # Maximum upload size (for admin file uploads)
    client_max_body_size 50M;

    # Timeouts (CRITICAL for image serving)
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;
    
    # Keep-alive settings
    keepalive_timeout 65s;
    keepalive_requests 100;

    # Buffer sizes for large responses
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 32k;

    # API Routes (Proxy to Node.js backend - port 5001)
    location /api {
        proxy_pass http://localhost:5001;
        proxy_http_version 1.1;
        
        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
        
        # Disable buffering for API responses
        proxy_buffering off;
        proxy_request_buffering off;
        
        # Timeouts for API
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Static Images - Directly served by Nginx (CRITICAL FIX)
    location /uploads/ {
        alias /var/www/learn-traffic-rules/backend/uploads/;
        
        # CRITICAL: Enable direct file serving (no proxy)
        # This fixes "Connection closed while receiving data" errors
        
        # Cache control
        expires 7d;
        add_header Cache-Control "public, immutable";
        
        # CORS headers (if needed for frontend)
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept";
        
        # Disable access logs for images (performance)
        access_log off;
        
        # Enable sendfile for efficient file serving
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # Timeouts for static files
        send_timeout 60s;
        
        # Try to serve the file directly
        try_files $uri $uri/ =404;
    }

    # Alternative: If images are still in backend/public folder
    location /public/ {
        alias /var/www/learn-traffic-rules/backend/public/;
        
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
        
        access_log off;
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        send_timeout 60s;
        
        try_files $uri $uri/ =404;
    }

    # Health check endpoint (proxy to backend)
    location /health {
        proxy_pass http://localhost:5001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Static HTML pages
    location = /privacy-policy {
        alias /var/www/learn-traffic-rules/backend/public/privacy-policy.html;
        default_type text/html;
    }
    location = /terms-conditions {
        alias /var/www/learn-traffic-rules/backend/public/terms-conditions.html;
        default_type text/html;
    }
    location = /delete-account-instructions {
        alias /var/www/learn-traffic-rules/backend/public/delete-account-instructions.html;
        default_type text/html;
    }

    # Error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # Logging
    access_log /var/log/nginx/drive-rwanda-prep-access.log;
    error_log /var/log/nginx/drive-rwanda-prep-error.log warn;
}
